@{
    ViewBag.Title = WebPages.HomePage_Title;
    if (IsAjax)
    {
        Layout = "";
    }
}
@model ParkingLotWebApp.Models.HomeIndexViewModel
@section PAGECSS{
    <link href="/assets/plugins/switchery/switchery.min.css" rel="stylesheet" />
    <link href="/assets/plugins/powerange/powerange.min.css" rel="stylesheet" />
}
@section PAGEJS{
    <script src="/assets/plugins/switchery/switchery.min.js"></script>
    <script src="/assets/plugins/powerange/powerange.min.js"></script>
    <script src="/assets/js/form-slider-switcher.demo.min.js"></script>
}
@if (!IsAjax)
{
    @section breadcrumb{
        <li class="active">儀錶板</li>
    }
    @section pageheader{
        <h1 class="page-header">儀錶板 <small>剩餘車位數量查詢</small></h1>
    }

    <div class="row" style="margin-top:20px;" id="autorefresh">
        <div class="col-xs-4 col-md-2">
            <div class="panel panel-inverse" data-sortable-id="ui-widget-1">
                <div class="panel-heading">
                    <div class="panel-heading-btn">
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-success" data-click="panel-reload"><i class="fa fa-repeat"></i></a>
                    </div>
                    <h4 class="panel-title">停車區域</h4>
                </div>
                <div class="panel-body" id="selectAreas">
                   @using (Ajax.BeginForm("Index", null, new AjaxOptions
                   {
                       UpdateTargetId = "selectAreas",
                       HttpMethod = "Post",
                       OnSuccess = "refreshSelect"
                   }, new { @id = "selectlocationform", @class = "form-horizontal", @role = "form" }))
                   {
                    @Html.AntiForgeryToken()
                       foreach (var key in Model.Areas.Keys)
                       {
                        <p>
                            <input type="checkbox" name="areaId" value="@key" data-render="switchery" data-theme="default" @((Model.SelectedAreas[key]) ? Html.Raw("checked") : Html.Raw("")) />
                            <span class="text-muted m-l-5 m-r-20">@Model.Areas[key]</span>
                        </p>
 
                       }
                   }
                </div>
            </div>
            
        </div>
        <div class="col-xs-8 col-md-10" id="showFloors">
            @using (Ajax.BeginForm("Reload", null, new AjaxOptions
            {
                UpdateTargetId = "showFloors",
                HttpMethod = "Post",
                OnSuccess = "autoReload"
            }, new { @id = "autoreload" }))
            {
                @Html.AntiForgeryToken()
                @Html.Hidden("shared_areaId", "")
                foreach (int key in Model.Areas.Keys)
                {
                    if (Model.SelectedAreas[key])
                    {
                        <div class="col-xs-12 col-md-4">
                            <div class="panel panel-inverse" data-sortable-id="form-slider-switcher-3">
                                <div class="panel-heading">                              
                                    <h4 class="panel-title">@Model.Areas[key]</h4>
                                </div>
                                <div class="panel-body">
                                    <table class="table table-bordered">
                                        <thead>
                                            @*<tr>
                                                @if (Model.RemainSummary[key].All(w => w.NoneFloor == false))
                                                {
                                                    <th colspan="3">@Model.Areas[key]</th>
                                                }
                                                else
                                                {
                                                    <th colspan="2">@Model.Areas[key]</th>
                                                }
                                            </tr>*@
                                            <tr>
                                                @if (Model.RemainSummary[key].All(p => p.NoneFloor == false))
                                                {
                                                    <th>樓層</th>
                                                }
                                                <th>@WebPages.ParkingLotsFloor_CarLastGrid</th>
                                                <th>@WebPages.ParkingLotsFloor_MotoLastGrid</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item_n in Model.RemainSummary[key])
                                            {
                                                <tr>
                                                    @if (item_n.NoneFloor == false)
                                                    {
                                                        <td>@item_n.樓層名稱</td>
                                                        <td>@item_n.剩餘停車格數</td>
                                                        <td>@item_n.剩餘機車格數</td>
                                                    }
                                                    else
                                                    {
                                                        <td>@item_n.剩餘停車格數</td>
                                                        <td>@item_n.剩餘機車格數</td>
                                                    }
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
         
                        </div>
                    }

                }
            }

        </div>
    </div>
    <script>
        var sharedAreaId = '@ViewBag.AreaId';
    </script>
    @section scripts{
        
        <script type="text/javascript">
            function autoReload() {
                console.debug('timer.');                
                $('#shared_areaId').val(sharedAreaId);
                console.debug('sharedAreaId:' + sharedAreaId);
                setTimeout('$(\'#autoreload\').submit();', 10000);
                @*$.ajax({
                    url: '@Url.Action("Reload")',
                    data: { areaId: $('[name="areaId"]').val() },
                    type: 'POST',
                    cache: false,
                    datatype: 'html',
                    headers: { 'RequestVerificationToken': '@RazorHelpFunctions.GetAntiForgeryToken()' },
                    success: function (data) {
                        $('#body').empty();
                        $('#body').html(data);
                        init();
                        setTimeout(function () { autoReload(); }, 10000);
                        //init();
                        //console.debug(data);
                        console.debug('auto reload.');
                    }
                });*@
            }
            function refreshSelect() {
                init();
                $('#autoreload').submit();
            }
            function init() {
                FormSliderSwitcher.init();
                $.ajaxSetup({ cache: false });
                $('#selectlocationform').live('change', function () {
                    $('#selectlocationform').submit();
                });
                $('#selectlocationform').on('click', ':checkbox', function () {                                       
                    console.debug('areaId triggered.');
                    $('#selectlocationform').submit();
                    //autoReload();
                });
                console.debug('event registered.');
                autoReload();
            }
          
        </script>
    }
}
else
{
    using (Ajax.BeginForm("Index", null, new AjaxOptions
    {
        UpdateTargetId = "selectAreas",
        HttpMethod = "Post",
        OnSuccess = "refreshSelect"
    }, new { @id = "selectlocationform", @class = "form-horizontal", @role = "form" }))
    {
        @Html.AntiForgeryToken()
        foreach (var key in Model.Areas.Keys)
        {
            <p>
                <input type="checkbox" name="areaId" value="@key" data-render="switchery" data-theme="default" @((Model.SelectedAreas[key]) ? Html.Raw("checked") : Html.Raw("")) />
                <span class="text-muted m-l-5 m-r-20">@Model.Areas[key]</span>
            </p>
        }
    }
    <script>
        var sharedAreaId = '@ViewBag.AreaId';
    </script>
}

